---
# ============================================
# Zsh Role
# ============================================
# Purpose: Install and configure Zsh with Oh My Zsh
# Runs with: become: no (user-level installation)
# ============================================

- name: Install Zsh package
  apt:
    name: zsh
    state: present
  become: yes

- name: Check if Oh My Zsh is already installed
  stat:
    path: "{{ home_dir }}/.oh-my-zsh"
  register: ohmyzsh_stat

- name: Install Oh My Zsh
  shell: |
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  args:
    creates: "{{ home_dir }}/.oh-my-zsh"
  when: not ohmyzsh_stat.stat.exists

- name: Check if zsh-autosuggestions is installed
  stat:
    path: "{{ home_dir }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
  register: autosuggestions_stat

- name: Clone zsh-autosuggestions plugin
  git:
    repo: https://github.com/zsh-users/zsh-autosuggestions
    dest: "{{ home_dir }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
    update: no
  when: not autosuggestions_stat.stat.exists

- name: Check if zsh-syntax-highlighting is installed
  stat:
    path: "{{ home_dir }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
  register: syntax_highlighting_stat

- name: Clone zsh-syntax-highlighting plugin
  git:
    repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
    dest: "{{ home_dir }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
    update: no
  when: not syntax_highlighting_stat.stat.exists

- name: Check if .zshrc already exists
  stat:
    path: "{{ home_dir }}/.zshrc"
  register: zshrc_stat

- name: Backup existing .zshrc if it exists
  copy:
    src: "{{ home_dir }}/.zshrc"
    dest: "{{ home_dir }}/.zshrc.backup.{{ ansible_date_time.iso8601_basic_short }}"
    remote_src: yes
  when: zshrc_stat.stat.exists
  ignore_errors: yes

- name: Deploy .zshrc from template
  template:
    src: zshrc.j2
    dest: "{{ home_dir }}/.zshrc"
    mode: '0644'

- name: Get current shell for user
  command: "getent passwd {{ ansible_user }}"
  register: current_shell
  changed_when: false

- name: Change default shell to Zsh
  command: "chsh -s /usr/bin/zsh {{ ansible_user }}"
  become: yes
  when: "'/usr/bin/zsh' not in current_shell.stdout"

- name: Display Zsh installation summary
  debug:
    msg: |
      Zsh configured successfully!
      - Theme: {{ zsh_theme }}
      - Plugins: {{ zsh_plugins | length }} enabled
      - Prompt icon: {{ zsh_prompt_icon }}
      - History: {{ zsh_histsize }} commands
